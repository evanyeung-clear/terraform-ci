name: Terraform Plan

on:
  workflow_call:
    inputs:
      runner:
        description: "Runner to use"
        required: false
        default: "ubuntu-latest"
        type: string
      directory:
        description: "Directory to run Terraform in"
        required: true
        type: string
      vars_file:
        description: "Optional path to Terraform variables file relative to the directory"
        required: false
        type: string
    secrets:
      sops_age_key:
        description: "Optional if you need to decode the variables file with SOPS"
        required: false

jobs:
  plan:
    runs-on: ${{ inputs.runner }}
    permissions:
      pull-requests: write
      statuses: write
    defaults:
      run:
        working-directory: ${{ inputs.directory }}

    steps:
      - name: Checkout pull request
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head.ref }}

      - name: Decrypt Terraform variables
        id: decrypt
        uses: ./.github/shared-actions/decrypt-sops
        if: inputs.vars_file != '' && env.SOPS_AGE_KEY != ''
        env:
          SOPS_AGE_KEY: ${{ secrets.sops_age_key }}
        with:
          working_directory: ${{ inputs.directory }}
          input_file: ${{ inputs.vars_file }}
          output_file: terraform.tfvars.json
          sops_age_key: ${{ secrets.sops_age_key }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Bake with Compose
        uses: docker/bake-action@v6
        with:
          source: "{{defaultContext}}:${{ inputs.directory }}"
          set: |
            *.cache-from=type=gha
            *.cache-to=type=gha,mode=max
            *.output=type=docker

      # if lock is active, use speculative state
      - name: Get PR and commit SHA
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            // core.setOutput("head_sha", pr.head.sha);
            core.setOutput("branch", pr.head.ref);
            // core.setOutput("mergeable_state", pr.mergeable_state);

      - name: Check deployment lock
        uses: forevanyeung/lock@e43a0b2920fca2eb45f02bde126d32e09949d419
        id: lock
        with:
          mode: check
          environment: ${{ inputs.directory }}

      - name: Check if lock is for this branch
        if: steps.lock.outputs.locked == 'true'
        uses: actions/github-script@v7
        id: lock-check
        with:
          script: |
            const lockedBranch = `${{ steps.lock.outputs.branch }}`;
            const currentBranch = `${{ steps.pr.outputs.branch }}`;
            console.log(`Locked branch: ${lockedBranch}, Current branch: ${currentBranch}`);

            // Check if the lock is held by this branch
            if (lockedBranch === currentBranch) {
              console.log('Lock is held by this branch, continuing.');
              core.setOutput("locked", "false");
            } else {
              console.log(`Lock is held by branch ${lockedBranch}, using speculative state.`);
              core.setOutput("locked", "true");
            }

      - name: Initialize Terraform
        env:
          SPEC_PLAN: ${{ steps.lock-check.outputs.locked == 'true' && 'true' || '' }}
          TF_TOKEN_APP_TERRAFORM_IO: ${{ secrets.TF_TOKEN_APP_TERRAFORM_IO }}
          TF_CLOUD_ORGANIZATION: ${{ secrets.TF_CLOUD_ORGANIZATION }}
        run: |
          docker compose run --rm terraform init -input=false
          docker compose run --rm terraform fmt -check
          docker compose run --rm terraform validate -no-color

      - name: Get Changed Terraform Targets
        id: targets
        run: |
          docker compose run --rm terraform plan -refresh=false -json | jq -r '.change.resource.addr|select(.!=null)|"-target="+.' | tr '\n' ' ' > targets.txt
          echo "targets=$(cat targets.txt)" >> $GITHUB_OUTPUT

      - name: Run Terraform Plan
        id: plan
        env:
          SPEC_PLAN: ${{ steps.lock-check.outputs.locked == 'true' && 'true' || '' }}
          TF_TOKEN_APP_TERRAFORM_IO: ${{ secrets.TF_TOKEN_APP_TERRAFORM_IO }}
          TF_CLOUD_ORGANIZATION: ${{ secrets.TF_CLOUD_ORGANIZATION }}
        run: |
          # Build terraform plan command based on vars file and SOPS usage
          cmd="terraform plan -no-color -input=false"

          # Add vars file if specified
          if [[ -n "${{ inputs.vars_file }}" ]]; then
            if [[ -n "${{ secrets.sops_age_key }}" && -n "${{ steps.decrypt.outputs.decrypted_file }}" ]]; then
              # Use decrypted file if SOPS was used
              cmd="$cmd -var-file=${{ steps.decrypt.outputs.decrypted_file }}"
              echo "Using SOPS-decrypted vars file: ${{ steps.decrypt.outputs.decrypted_file }}"
            else
              # Use original vars file if no SOPS
              cmd="$cmd -var-file=${{ inputs.vars_file }}"
              echo "Using vars file: ${{ inputs.vars_file }}"
            fi
          fi

          # Only target resources that are modified in code
          targets=${{ steps.targets.outputs.targets }}
          echo "Targets: $targets"
          cmd="$cmd $targets"

          echo "Terraform command: $cmd"

          start=$(date +%s)

          # handle errors and capture output
          set +e
          docker compose run $cmd 2>&1 | tee tf.console.txt
          status=${PIPESTATUS[0]}
          set -e

          end=$(date +%s)

          echo "duration=$((end - start))" >> $GITHUB_OUTPUT
          echo "cmd=$cmd" >> $GITHUB_OUTPUT

          if [ $status -ne 0 ]; then
            echo "Terraform plan failed."
            exit 1
          fi

      - name: Format Terraform Plan Diff
        id: diff
        run: |
          # Strip extra lines from tf.console.txt
          awk '
            BEGIN {skip=0}
            /^Warning:/ {skip=1}
            skip && (/^Note that the -target option/ || /^The -target option/) {skip=2; next} skip==2 && NF==0 {skip=0; next}
            skip {next}
            {print}
          ' tf.console.txt | 
          awk '/^─────/,EOF {next} {print}' > tf.console.stripped.txt || true

          # Filter lines starting with "  # " and prepend diff-specific symbols based on specific keywords.
          # https://github.com/OP5dev/TF-via-PR
          grep '^  # ' tf.console.txt | sed \
            -e 's/^  # \(.* be created\)/+ \1/' \
            -e 's/^  # \(.* be destroyed\)/- \1/' \
            -e 's/^  # \(.* be updated\|.* be replaced\)/! \1/' \
            -e 's/^  # \(.* be read\)/~ \1/' \
            -e 's/^  # \(.*\)/# \1/' > tf.diff.txt || true

          # Grab the summary lines for the expand text
          awk '/^(Error:|Plan:|Apply complete!|No changes.|Success)/' tf.console.txt > tf.summary.txt
      - name: Comment Terraform Plan
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            // Helper function to safely read files with a default value
            function safeReadFile(filePath, defaultContent = '') {
              try {
                return fs.readFileSync(filePath, 'utf8');
              } catch (error) {
                console.log(`Warning: Could not read file ${filePath}: ${error.message}`);
                return defaultContent;
              }
            }

            // Helper function to mark previous comment as out of date
            async function markOutdated(search, notice) {
              const comments = await github.rest.issues.listComments({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });

              for (const comment of comments.data) {
                if (comment.body && comment.body.includes(search) && !comment.body.includes(notice)) {
                  // Prepend '> ' to each line of comment.body for quoting
                  const quotedBody = comment.body.split('\n').map(line => '> ' + line).join('\n');
                  await github.rest.issues.updateComment({
                    comment_id: comment.id,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: '<details><summary>' + notice + '</summary>\n\n' + quotedBody + '\n</details>'
                  });

                  // Hide comment
                  const mutation = `mutation($subjectId:ID!, $classifier:ReportedContentClassifiers!) {
                    minimizeComment(input: { subjectId: $subjectId, classifier: $classifier }) {
                      clientMutationId
                      minimizedComment {
                        isMinimized
                        minimizedReason
                        viewerCanMinimize
                      }
                    }
                  }`;

                  console.log(`Hiding comment ${comment.id} (${comment.node_id})`);

                  const result = await github.graphql(mutation, {
                    subjectId: comment.node_id,
                    classifier: 'OUTDATED'
                  });

                  console.log(result);
                }
              }
            }

            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const diff = safeReadFile('${{ inputs.directory }}/tf.diff.txt', 'No changes detected');
            const summary = safeReadFile('${{ inputs.directory }}/tf.summary.txt', 'View output for details');
            const cleanPlan = safeReadFile('${{ inputs.directory }}/tf.console.stripped.txt', 'No plan output available');

            // Find previous plan comment and mark as out of date
            const planCommentTag = `**Terraform plan** (Okta ${{ inputs.directory }})`;
            const planOutOfDateNotice = 'This plan is out of date. A new plan has been performed.';
            markOutdated(planCommentTag, planOutOfDateNotice);

            // Find previous apply comment and mark as out of date
            const applyCommentTag = `**Terraform apply** (Okta ${{ inputs.directory }})`;
            const applyOutOfDateNotice = 'This apply is out of date. A new apply has been performed.';
            markOutdated(applyCommentTag, applyOutOfDateNotice);

            var body = `
            **Terraform plan** (Okta ${{ inputs.directory }}) ran in [${{ steps.plan.outputs.duration }} seconds](${runUrl}).
            \`\`\`
            ${{ steps.plan.outputs.cmd }}
            \`\`\`

            #### Diff of changes
            \`\`\`diff
            ${diff}
            \`\`\`

            <details>
            <summary>${summary}</summary>

            \`\`\`
            ${cleanPlan}
            \`\`\`
            </details>
            `

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })

      - name: Add help to apply commit status
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: "${{ github.event.pull_request.head.sha }}",
              state: "pending",
              context: "terraform-apply",
              description: "Comment \"/terraform apply\" to deploy changes",
            });

  # test:
  #   if: ${{ !always() }}
  #   runs-on: ${{ inputs.runner }}
  #   needs: run
  #   steps:
  #     - name: Check Terraform Plan Output
  #       run: |
  #         echo "Checking Terraform Plan Output..."
  #         echo "Terraform plan ran in ${{ needs.run.outputs.terraform_time_elapsed }} seconds."
  #         echo "Terraform command: ${{ needs.run.outputs.terraform_cmd }}"
